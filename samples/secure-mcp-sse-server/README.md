# Secure MCP SSE Server

This demo shows how a user can login to Keycloak and use the access token to access a secure MCP SSE server and tools.

## Dev mode

### Start application in the dev mode

Start the application in the dev mode:

```shell script
./mvnw quarkus:dev
```

It also starts a https://quarkus.io/guides/security-openid-connect-dev-services#dev-services-for-keycloak[Keycloak Dev Services container].

[NOTE]
====
Adding the `quarkus.keycloak.devservices.java-opts=-XX:UseSVE=0` configuration property may help to workaround Keycloak Dev Services startup problems on some Mac OS systems.

Alternatively, you can enable a https://quarkus.io/guides/security-openid-connect-dev-services#dev-services-for-oidc[lightweight OIDC Dev Services] option with `quarkus.oidc.devservices.enabled=true`.
====

### Use OIDC Dev UI to login to Keycloak and copy the access token

Use https://quarkus.io/guides/security-openid-connect-dev-services#dev-services-for-keycloak[OIDC DevUI] to login to Keycloak as a user `alice` with a password `alice` and copy an acquired access token.

### Use MCP Server Dev UI to call the tool

Go to https://quarkus.io/guides/dev-ui[Dev UI] and select the MCP Server card.

Choose  the `user-name-provider` tool in `Tools`, paste the copied access token to the `Bearer token` field, select `Force New Session` and call the tool.

MCP Server Dev UI will show a tool response which contains the `alice` user name.

## Prod mode

### Register GitHub OAuth2 application

Follow the GitHub application registration[https://quarkus.io/guides/security-openid-connect-providers#github] process, and make sure to register the `http://localhost:8080/login` callback URL.

Uncomment the lines in `application.properties` which contain `${github-client-id}` and `${github-client-secret}` and provide the client id and secret generated by GitHub.

### Install and run application

The application can be packaged and installed using:

```shell script
./mvnw install
```

Run it with `jbang`:

```shell script
jbang org.acme:secure-mcp-sse-server:1.0.0-SNAPSHOT:runner
```

### Login to GitHub and copy the access token

Access `http://localhost:8080/login`, login to GitHub, and copy the returned access token.

[NOTE]
====
By default, Quarkus GitHub provider submits the client id and secret in the HTTP Authorization header.
However, GitHub may require that both client id and secret are submitted as form parameters instead.

When you get HTTP 401 error after logging in to GitHub and being redirected back to Quarkus MCP server,
try to replace `%prod.quarkus.oidc.login.credentials.secret=${github.client.secret}` property
with the following two properties instead:

```properties
%prod.quarkus.oidc.login.credentials.client-secret.method=post
%prod.quarkus.oidc.login.credentials.client-secret.value=${github.client.secret}
```
====

### Use MCP inspector to call the tool

Launch MCP inspector:

```shell script
npx @modelcontextprotocol/inspector
```

Paste the copied GitHub access token to its `Bearer token` field and connect it to `http://localhost:8080/mcp/sse`.

Select and call the `user-name-provider` tool and see MCP inspector returning the name from your GitHub account returned.

### Use curl to call the tool

Use the access token to access MCP server:

```shell script
curl -v -H "Authorization: Bearer gho_..." localhost:8080/mcp/sse
```

and get an SSE response such as:

```shell script
< content-type: text/event-stream
< 
event: endpoint
data: /messages/ZTZjZDE5MzItZDE1ZC00NzBjLTk0ZmYtYThiYTgwNzI1MGJ
```

The SSE connection is now created.

Now open another window and use the same access token to initialize the curl as MCP client, and access the tool, using the value of the `data` property to build the target URL.

#### Initialize the client

Initialize the client:

```shell script
curl -v -H "Authorization: Bearer gho_..." -H "Content-Type: application/json" --data @initialize.json http://localhost:8080/mcp/messages/ZTZjZDE5MzItZDE1ZC00NzBjLTk0ZmYtYThiYTgwNzI1MGJ
```

where a `initialize.json` looks like this:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "roots": {
        "listChanged": true
      },
      "sampling": {}
    },
    "clientInfo": {
      "name": "CurlClient",
      "version": "1.0.0"
    }
  }
}
```

and send the initialization confirmation:

```shell script
curl -v -H "Authorization: Bearer gho_..." -H "Content-Type: application/json" --data @initialized.json http://localhost:8080/mcp/messages/ZTZjZDE5MzItZDE1ZC00NzBjLTk0ZmYtYThiYTgwNzI1MGJ
```

where a `initialized.json` looks like this:

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/initialized"
}
```

#### Call the tool

```shell script
curl -v -H "Authorization: Bearer gho_..." -H "Content-Type: application/json" --data @call.json http://localhost:8080/mcp/messages/ZTZjZDE5MzItZDE1ZC00NzBjLTk0ZmYtYThiYTgwNzI1MGJ
```

where a `call.json` looks like this:

```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/call",
  "params": {
    "name": "user-name-provider",
    "arguments": {
    }
  }
}
```

Now look in the SSE connection window and you will see the name from your GitHub account returned.
